#!/bin/bash
set -ev

# Configuration.
export CATKIN_WS=~/catkin_ws
export CATKIN_WS_SRC=${CATKIN_WS}/src
export DEBIAN_FRONTEND=noninteractive

# Dependencies.
apt-get update -qq
apt-get install -qq -y wget
echo "deb [trusted=yes] http://packages.osrfoundation.org/gazebo/ubuntu-stable bionic main" > /etc/apt/sources.list.d/gazebo-stable.list
echo "deb [trusted=yes] http://packages.osrfoundation.org/gazebo/ubuntu-prerelease bionic main" > /etc/apt/sources.list.d/gazebo-prerelease.list
echo "deb [trusted=yes] http://packages.ros.org/ros/ubuntu bionic main" > /etc/apt/sources.list.d/ros-latest.list
wget http://packages.osrfoundation.org/gazebo.key -O - | apt-key add -
apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
apt-get update -qq
apt-get install -qq -y libignition-msgs4-dev \
                       libignition-transport7-dev \
                       python-catkin-tools \
                       python-rosdep \
                       ros-melodic-geometry-msgs \
                       ros-melodic-mav-msgs \
                       ros-melodic-rostest \
                       ros-melodic-sensor-msgs
rosdep init
rosdep update
rosdep install --from-paths ./ -i -y --rosdistro melodic

# Build.
source /opt/ros/melodic/setup.bash
mkdir -p $CATKIN_WS_SRC
ln -s /code $CATKIN_WS_SRC
cd $CATKIN_WS
catkin init
catkin config --install
catkin build --limit-status-rate 0.1 --no-notify -DCMAKE_BUILD_TYPE=Release
catkin build --limit-status-rate 0.1 --no-notify --make-args tests

# Tests.
catkin run_tests
